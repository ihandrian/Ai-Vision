# Object Detection with Video Input - Guide

## Overview

The `objvision.py` file has been updated to work with video input instead of window capture. This makes it compatible with your project workflow and allows you to use trained YOLOv4-tiny models from Google Colab.

## Key Changes

### 1. Removed Windows-Specific Dependencies
- **Removed**: `WindowCapture` class that used `win32gui`, `win32ui`, `win32con`
- **Replaced with**: `VideoCapture` class using OpenCV for video file input
- **Benefit**: Cross-platform compatibility (Windows, Linux, Mac)

### 2. Video Input Support
- Supports video files (`.mp4`, `.avi`, `.mov`, etc.)
- Supports webcam input (pass `0` as video_path)
- Automatically detects video properties (resolution, FPS, frame count)

### 3. Improved ImageProcessor
- Better error handling for missing files
- Auto-detects class names from multiple locations:
  - `yolov4-tiny/obj.names` (default)
  - `classes.txt` (fallback)
  - Custom path via parameter
- Supports unlimited classes with auto-generated colors
- Shows confidence scores in labels

### 4. Enhanced Features
- **Save output video**: Option to save processed video with detections
- **Pause/Resume**: Press 'p' to pause during playback
- **Better logging**: More informative output during processing
- **Structured output**: Returns detection data for further analysis

## Usage

### Basic Usage

```python
from app.objvision import process_video

# Process a video file
detections = process_video(
    video_path="media/Sheep.mp4",
    cfg_file="./yolov4-tiny/yolov4-tiny-custom.cfg",
    weights_file="yolov4-tiny-custom_last.weights",
    confidence_threshold=0.5,
    display=True,
    save_output=False
)
```

### Using Webcam

```python
# Use webcam (camera index 0)
detections = process_video(
    video_path=0,  # Camera index
    cfg_file="./yolov4-tiny/yolov4-tiny-custom.cfg",
    weights_file="yolov4-tiny-custom_last.weights"
)
```

### Save Output Video

```python
detections = process_video(
    video_path="media/Sheep.mp4",
    cfg_file="./yolov4-tiny/yolov4-tiny-custom.cfg",
    weights_file="yolov4-tiny-custom_last.weights",
    save_output=True,
    output_path="output_detected.mp4"  # Optional, auto-generated if None
)
```

### Using Classes Directly

```python
from app.objvision import VideoCapture, ImageProcessor

# Initialize video capture
video = VideoCapture("media/Sheep.mp4")
img_size = video.get_window_size()

# Initialize processor
processor = ImageProcessor(
    img_size=img_size,
    cfg_file="./yolov4-tiny/yolov4-tiny-custom.cfg",
    weights_file="yolov4-tiny-custom_last.weights",
    names_file="yolov4-tiny/obj.names"  # Optional
)

# Process frames
while True:
    frame = video.get_frame()
    if frame is None:
        break
    
    detections = processor.process_image(frame, confidence_threshold=0.5)
    
    # Use detections
    for det in detections:
        print(f"Found {det['class_name']} with confidence {det['confidence']:.2f}")

video.release()
```

## Workflow Integration

### After Training in Google Colab

1. **Download trained weights**:
   - Download `yolov4-tiny-custom_last.weights` from Colab
   - Place in project root directory

2. **Ensure config file exists**:
   - Your config file should be at `yolov4-tiny/yolov4-tiny-custom.cfg`
   - This is generated by your `LabelUtils.update_config_files()` method

3. **Class names**:
   - Should be in `yolov4-tiny/obj.names` (created by LabelUtils)
   - Or in `classes.txt` (fallback)

4. **Run detection**:
   - Option A: Use the main menu (Option 4)
     ```bash
     python main.py
     # Then select option 4
     ```
   - Option B: Run directly
     ```bash
     python -m app.objvision
     ```
   - Option C: Import and use programmatically
     ```python
     from app.objvision import process_video
     ```

## Configuration Options

### Video Input
- **Video file**: Path to `.mp4`, `.avi`, `.mov`, etc.
- **Webcam**: Integer (e.g., `0` for default camera)

### Detection Settings
- **confidence_threshold**: Minimum confidence (0.0-1.0)
  - Lower = more detections (may include false positives)
  - Higher = fewer detections (more confident results)
  - Default: `0.5`

### Output Options
- **display**: Show video window during processing (default: `True`)
- **save_output**: Save processed video to file (default: `False`)
- **output_path**: Custom output path (auto-generated if `None`)

## Keyboard Controls

During video playback:
- **'q'**: Quit and exit
- **'p'**: Pause/Resume playback

## File Structure Expected

```
ObjectDetection/
├── app/
│   └── objvision.py                # Detection script
├── classes.txt                     # Class names (optional, fallback)
├── yolov4-tiny-custom_last.weights # Trained weights (from Colab)
├── yolov4-tiny/
│   ├── yolov4-tiny-custom.cfg      # Config file
│   └── obj.names                   # Class names
└── media/
    └── Sheep.mp4                   # Input video
```

## Differences from Original

| Original (Window Capture) | New (Video Input) |
|---------------------------|-------------------|
| `WindowCapture` class | `VideoCapture` class |
| Windows-only (`win32gui`) | Cross-platform (OpenCV) |
| Captures game window | Reads video files |
| Fixed window size | Auto-detects video properties |
| No output saving | Optional output video saving |
| Limited to 6 colors | Unlimited colors (auto-generated) |

## Troubleshooting

### "Video file not found"
- Check that the video path is correct
- Ensure video file exists in the specified location
- Use absolute path if relative path doesn't work

### "Weights file not found"
- Download trained weights from Google Colab
- Place in project root or update `weights_file` path

### "Config file not found"
- Ensure config file exists at `yolov4-tiny/yolov4-tiny-custom.cfg`
- Run `LabelUtils.update_config_files()` if needed

### "Could not find class names file"
- Ensure `yolov4-tiny/obj.names` exists
- Or ensure `classes.txt` exists in project root
- Or provide `names_file` parameter explicitly

### Poor Detection Performance
- Lower `confidence_threshold` to see more detections
- Check that weights file matches your config file
- Ensure video quality is good
- Verify model was trained on similar data

### Video Playback Issues
- Check that OpenCV can read your video format
- Try converting video to `.mp4` format
- Check video codec compatibility

## Integration with Main Project

The updated `objvision.py` integrates seamlessly with your existing project:

1. **Uses same class names**: Reads from `classes.txt` or `yolov4-tiny/obj.names`
2. **Compatible config**: Works with config files generated by `LabelUtils`
3. **Video input**: Uses same video files from `media/` folder
4. **No conflicts**: Doesn't interfere with `main.py` workflow

## Example: Complete Workflow

```python
# 1. Train model in Google Colab (using your existing workflow)
# 2. Download weights: yolov4-tiny-custom_last.weights

# 3. Run detection on video
from app.objvision import process_video

detections = process_video(
    video_path="media/Sheep.mp4",
    cfg_file="./yolov4-tiny/yolov4-tiny-custom.cfg",
    weights_file="yolov4-tiny-custom_last.weights",
    confidence_threshold=0.5,
    save_output=True,
    output_path="media/Sheep_detected.mp4"
)

# 4. Analyze results
total_objects = sum(len(d['detections']) for d in detections)
print(f"Total objects detected: {total_objects}")
```

## Next Steps

1. Train your model in Google Colab using your existing workflow
2. Download the trained weights file
3. Run detection via main menu (Option 4) or directly
4. Optionally save output videos with detections drawn

## Integration with Main Menu

The detection functionality is now integrated into the main menu:
- Run `python main.py` and select option 4
- The menu will guide you through selecting a video and configuring detection settings
- All paths are automatically resolved relative to the project root

